<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright Â© 2018 SailPoint Technologies, Inc. All Rights Reserved.
All logos, text, content, and works of authorship, including but not limited to underlying code, programming or scripting language, designs, and/or graphics,
that are used and/or depicted herein are protected under United States and international copyright and trademark laws and treaties,
and may not be used or reproduced without the prior express written permission of SailPoint Technologies, Inc. -->
<project name="accelerator.pack.layout">
    <target name="-iiqBinaries" depends="-gApatchEfix,-copyWebAcceleratorPackToBuildExtract"/>
    <target name="-gApatchEfix">
        <if>
            <not>
                <available file="base/ga/identityiq-${IIQVersion}.zip"/>
            </not>
            <then>
                <property name="critical.failure"
                          value="Could not find file (identityiq-${IIQVersion}.zip}) IIQ GA binaries for the specified build version ${IIQVersion} in the /base/ga directory. You can download these files from https://community.sailpoint.com "/>
               <fail message="${critical.failure}"/>
            </then>
        	<else>
        	     <echo>IdentityIQ GA Exists base/ga/identityiq-${IIQVersion}.zip.</echo>
        	 </else>
        </if>
        <if>
            <and>
                <and>
                    <isset property="IIQPatchLevel"/>
                    <length string="${IIQPatchLevel}" when="greater" length="2"/>
                </and>
                <not>
                    <available file="base/patch/identityiq-${IIQVersion}${IIQPatchLevel}.jar"/>
                </not>
            </and>
            <then>
                <property name="critical.failure"
                          value="Could not find file (identityiq-${IIQVersion}${IIQPatchLevel}.jar}) IIQ patch binaries for the specified build version ${IIQVersion}${IIQPatchLevel} in the /base/patch directory.  You can download these files from https://community.sailpoint.com "/>
                <fail message="${critical.failure}"/>
            </then>
            <else>
                <echo>IdentityIQ Patch Exists base/patch/${IIQVersion}${IIQPatchLevel}</echo>
            </else>
        </if>
    	<if>
	  	       <available file="base/efix/${IIQVersion}${IIQPatchLevel}" type="dir"/>
	  	  	    <then>
	  	  	        <echo>IdentityIQ Efix Exists base/efix/${IIQVersion}${IIQPatchLevel} ...</echo>
	  	  	    </then>
	  	       <else>
	  	       	  <mkdir dir="base/efix/${IIQVersion}${IIQPatchLevel}"/>
	  	     	  <echo>Created New Efix Directory: base/efix/${IIQVersion}${IIQPatchLevel} ...</echo>
	  	       </else>    	  	
	  	  </if>    	
        <if>
            <not>
                <available file="${build.iiqBinaryExtract}"/>
            </not>
            <then>
                <trycatch property="critical.failure">
                    <try>
                        <mkdir dir="${build.iiqBinaryExtract}"/>
                        <unzip dest="${build.iiqBinaryExtract}">
                            <fileset dir="base/ga/">
                                <include name="identityiq-${IIQVersion}.zip"/>
                            </fileset>
                        </unzip>
                    	<echo>Expansion IdentityIQ GA base/ga/identityiq-${IIQVersion}.zip.</echo>
                        <unzip dest="${build.iiqBinaryExtract}">
                            <fileset dir="${build.iiqBinaryExtract}">
                                <include name="identityiq.war"/>
                            </fileset>
                        </unzip>
                    	<echo>Expansionidentityiq.war..</echo>
                        <delete file="${build.iiqBinaryExtract}/identityiq.war"/>
                        <unzip dest="${build.iiqBinaryExtract}">
                            <fileset dir="base/patch">
                                <include name="identityiq-${IIQVersion}${IIQPatchLevel}.jar"/>
                            </fileset>
                        </unzip>
                    	<echo>Overlayed IdentityIQ Patch base/patch/${IIQVersion}${IIQPatchLevel}</echo>
                        <unzip dest="${build.iiqBinaryExtract}">
                            <fileset dir="base/efix/${IIQVersion}${IIQPatchLevel}">
                            	<include name="*.jar"/>
                            	<include name="*.zip"/>                            	
                            </fileset>
                        </unzip>
                    	<echo>Overlayed IdentityIQ Efix base/efix/${IIQVersion}${IIQPatchLevel}</echo>
                    </try>
                    <catch>
                        <echo>Critical failure while extracting core binaries. Make sure required files exit, ${line.separator}
                            are not corrupted and a directory exists for /base/efix/x.xpx version your are building.${line.separator}
                            Note: You need a directory (Ex. /base/efix/5.1p3 ) even if you don't have any efixes yet.
                        </echo>
                        <fail message="${critical.failure}"/>
                    </catch>
                </trycatch>
            </then>
        </if>
    </target>
    <target name="-copyWebAcceleratorPackToBuildExtract">
		<copy todir="${build.iiqBinaryExtract}" overwrite="true">
		    <fileset dir="web">
		        <include name="**/*"/>
		    </fileset>
		</copy>	
    </target>
    <target name="dist" depends="init-properties">
        <mkdir dir="${IIQHome}"/>
        <copy todir="${IIQHome}">
            <fileset dir="${build.iiqBinaryExtract}">
                <include name="**/*"/>
            </fileset>
        </copy>
    </target>
</project>