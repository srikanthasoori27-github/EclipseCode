<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<!-- Copyright Â© 2018 SailPoint Technologies, Inc. All Rights Reserved.
All logos, text, content, and works of authorship, including but not limited to underlying code, programming or scripting language, designs, and/or graphics,
that are used and/or depicted herein are protected under United States and international copyright and trademark laws and treaties,
and may not be used or reproduced without the prior express written permission of SailPoint Technologies, Inc. -->
<Workflow explicitTransitions="true"
	handler="sailpoint.api.StandardWorkflowHandler" name="Workflow-QuickLink-Recovery-Tool" type="LCMProvisioning">
	<Description>Accelerator Pack Recover Identity Access Workflow</Description>
	<Variable initializer="true" name="transient">
	</Variable>
	<Variable initializer="ref:launcher" name="owner">
	</Variable>
	<Variable initializer="identityName" >
	</Variable>
	<Variable initializer="identityDisplayName" >
	</Variable>
	<Variable initializer="requestEligibility" >
	</Variable>
	 <Variable name="spExtAttrs" />
	<Variable initializer="false" name="trace">
	</Variable>
	<Variable editable="true" name="requestType">
 	 </Variable>
  	<Variable name="plan" />
  	<Variable name="project" />
  	<Variable name="recoveryComments" />
  	<Variable name="provisioningErrors" />
  	<Variable name="flow" initializer="AccessRequest">
    <Description>The name of the identity.</Description>
  	</Variable>
	<Variable name="source" initializer="string:LCM">
	<Description>The name of the identity.</Description>
	</Variable>
	<Variable name="identityRequestId">
	<Description>Selected Id</Description>
	</Variable>
  <RuleLibraries>          
    <Reference class="sailpoint.object.Rule" name="Rule-Recover-RuleLibrary"/>    
    <Reference class="sailpoint.object.Rule" name="Rule-Framework-NotificationRuleLibrary" />
  </RuleLibraries>
	<Step icon="Start" name="Start" posX="28" posY="10">
		<Transition to="Get Request Type" />
	</Step>
	  <Step  name="Get Request Type" posX="98" posY="10" resultVariable="requestType">
    <Script>
      <Source>
      	return getRequestTypeName(context, workflow);
      </Source>
    </Script>
     <Transition to="Select Identity Request" />
  </Step>
	<Step name="Select Identity Request">
		<Approval description="Identity Request" owner="ref:requester" return="identityRequestId, recoveryComments">
	      <Form>
	        <Attributes>
	          <Map>
	            <entry key="pageTitle" value="Select Identity Request To Recover"/>
	          </Map>
	        </Attributes>
	           <Section label="Select" type="text">
	          <Field value="Please enter the Identity Request Id"/>
	        </Section>
	        <Section>
	          <Field displayName="Identity Request" name="identityRequestId" required="true" type="sailpoint.object.IdentityRequest"/>
	          <Field displayName="Reason" required="true" displayType="textarea" name="recoveryComments"/>
	        </Section>
	        <Button action="back" label="Cancel Request"/>
	        <Button action="next" label="Next"/>
	      </Form>
	    </Approval>
		<Transition to="Confirm Identity Request To Recover" when="script:approved" />
		<Transition to="end" />
	</Step>
	<Step name="Confirm Identity Request To Recover" posX="234" posY="114">
		<Approval owner="ref:owner" send="identityRequestId,recoveryComments">
			<Form>
				<Attributes>
					<Map>
						<entry key="hideIncompleteFields" value="true" />
						<entry key="pageTitle" value="Confirmation on Recovery Process" />
					</Map>
				</Attributes>
				<Button action="next" label="Confirm" />
				<Button action="back" label="Cancel" />
				<Section label="Identity Request" columns="4" type="datatable">
					<Field displayName="ID" readOnly="true">
					<Script>
						<Source>
							import org.apache.commons.logging.Log;
							import org.apache.commons.logging.LogFactory;
							import sailpoint.object.IdentityRequest;
							import sailpoint.rapidapponboarding.logger.LogEnablement;
							private Log logger = LogFactory.getLog("rapidapponboarding.rules");
							String retVal = "";
							IdentityRequest idReq=context.getObjectById(IdentityRequest.class, identityRequestId);
							if(idReq!=null)
							{
								retVal = idReq.getName();
								context.decache(idReq);
							}
							return retVal;
						</Source>
					</Script>
					</Field>
				</Section>
				<Section label="Reason" columns="2" type="datatable">
					<Field displayName="Comments" readOnly="true" value="ref:recoveryComments"/>
				</Section>
			</Form>
		</Approval>
		<Transition to="Build Plan" when="approved" />
		<Transition to="end" when="!approved" />
	</Step>
	<Step name="Build Plan">
		<Arg name="identityRequestId" value="ref:identityRequestId" />
		<Arg name="recoveryComments" value="ref:recoveryComments" />
		<Script>
			<Source>
				<![CDATA[ 
			    import sailpoint.object.ProvisioningPlan;
			    ProvisioningPlan recoverPlan = new ProvisioningPlan();
			    String result=buildExecuteRecoveryPlan(identityRequestId,workflow,recoveryComments);
			    if(result!=null && result.length()>0)
			    {
			    workflow.put("requestEligibility",result);
			    }
			   ]]>
			</Source>
		</Script>
		<Transition to="Error Screen" when="script:(requestEligibility!=void  &amp;&amp; requestEligibility!=null)" />
		<Transition to="end" />
	</Step>
	<Step name="Error Screen" posX="234" posY="114">
		<Approval owner="ref:owner" send="requestEligibility">
			<Form>
				<Attributes>
					<Map>
						<entry key="hideIncompleteFields" value="true" />
					</Map>
				</Attributes>
			<Section label="Unable to complete your recovery">
				<Field displayName="Recovery Result" name="recoveryResult" readOnly="true" value="ref:requestEligibility">
				</Field>
			</Section>
				<Button action="next" label="Close" />
			</Form>
		</Approval>
		<Transition to="end" />
	</Step>
  	<Step icon="Stop" name="end" posX="502" posY="10" />
</Workflow>
