<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Application PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Application connector="sailpoint.connector.OpenConnectorAdapter"  featuresString="NO_AGGREGATION, PROVISIONING, UNLOCK, ENABLE, PASSWORD" name="Element ServiceNow Service Desk" profileClass="" type="ServiceNow Service Desk">
  <Attributes>
    <Map>
      <entry key="afterProvisioningRule"/>
      <entry key="authenticationType" value="Basic"/>
      <entry key="beforeProvisioningRule"/>
      <entry key="changeRequest">
        <value>
          <Map>
            <entry key="checkStatus">
              <value>
                <Map>
                  <entry key="checkStatusQueryParam">
                    <value>
                      <Map>
                        <entry key="sysparm_fields" value="state,close_code"/>
                        <entry key="sysparm_query" value="number=$ticketId"/>
                      </Map>
                    </value>
                  </entry>
                  <entry key="closureCodeResponseElement" value="$.result[0].close_code"/>
                  <entry key="resource" value="/api/now/table/change_request"/>
                  <entry key="responseElement" value="$.result[0].state"/>
                  <entry key="statusMap">
                    <value>
                      <Map>
                        <entry key="-1" value="Queued"/>
                        <entry key="-2" value="Queued"/>
                        <entry key="-3" value="Queued"/>
                        <entry key="-4" value="Queued"/>
                        <entry key="-5" value="Queued"/>
                        <entry key="0" value="Queued"/>
                        <entry key="3" value="Committed"/>
                        <entry key="4" value="Failed"/>
                      </Map>
                    </value>
                  </entry>
                  <entry key="statusMapClosureCode">
                    <value>
                      <Map>
                        <entry key="successful" value="Committed"/>
                        <entry key="successful_issues" value="Committed"/>
                        <entry key="unsuccessful" value="Failed"/>
                      </Map>
                    </value>
                  </entry>
                </Map>
              </value>
            </entry>
            <entry key="provision">
              <value>
                <Map>
                  <entry key="request">
                    <value>
                      <Map>
                        <entry key="u_assignment_group" value="Service Desk"/>
                        <entry key="u_category" value="Other"/>
                        <entry key="u_description" value="#foreach($req in $plan.requests) #if($req.operation == &apos;Create&apos;) Create Account on application $req.resource #else For $req.id in application $req.resource #end #if($req.items) $newline  #foreach($item in $req.items) #if ($item.name == &apos;*disabled*&apos; &amp;&amp; $item.value == &apos;true&apos;) Disable Account. $newline #elseif ($item.name == &apos;*disabled*&apos; &amp;&amp; $item.value == &apos;false&apos;) Enable Account. $newline #elseif ($item.name == &apos;*locked*&apos; &amp;&amp; $item.value == &apos;false&apos;) Unlock Account. $newline #else $!item.Operation $item.name: $item.value $newline #end #end #else $newline $!req.Operation Account #end #end"/>
                        <entry key="u_impact" value="3"/>
                        <entry key="u_priority" value="4"/>
                        <entry key="u_requested_by" value="$!plan.arguments.opened_by"/>
                        <entry key="u_risk" value="4"/>
                        <entry key="u_short_description" value="IdentityIQ Access Request $!plan.arguments.identityRequestId"/>
                      </Map>
                    </value>
                  </entry>
                  <entry key="resource" value="/api/now/import/x_sap_sdim_change_request"/>
                  <entry key="responseElement" value="$.result[0].display_value"/>
                </Map>
              </value>
            </entry>
          </Map>
        </value>
      </entry>
      <entry key="compositeDefinition"/>
      <entry key="connectorAppForServiceNow" value="ServiceNOW"/>
      <entry key="connectorClass" value="openconnector.connector.servicedesk.ServiceDeskConnector"/>
      <entry key="encrypted" value="client_secret,refresh_token,oauth_token_info"/>
      <entry key="incident">
        <value>
          <Map>
            <entry key="checkStatus">
              <value>
                <Map>
                  <entry key="checkStatusQueryParam">
                    <value>
                      <Map>
                        <entry key="sysparm_fields" value="incident_state,close_code"/>
                        <entry key="sysparm_query" value="number=$ticketId"/>
                      </Map>
                    </value>
                  </entry>
                  <entry key="closureCodeResponseElement" value="$.result[0].close_code"/>
                  <entry key="resource" value="/api/now/table/incident"/>
                  <entry key="responseElement" value="$.result[0].incident_state"/>
                  <entry key="statusMap">
                    <value>
                      <Map>
                        <entry key="1" value="Queued"/>
                        <entry key="2" value="Queued"/>
                        <entry key="3" value="Queued"/>
                        <entry key="6" value="Committed"/>
                        <entry key="7" value="Committed"/>
                        <entry key="8" value="Failed"/>
                      </Map>
                    </value>
                  </entry>
                  <entry key="statusMapClosureCode">
                    <value>
                      <Map>
                        <entry key="Closed/Resolved by Caller" value="Committed"/>
                        <entry key="Not Solved (Not Reproducible)" value="Failed"/>
                        <entry key="Not Solved (Too Costly)" value="Failed"/>
                        <entry key="Solved (Permanently)" value="Committed"/>
                        <entry key="Solved (Work Around)" value="Committed"/>
                        <entry key="Solved Remotely (Permanently)" value="Committed"/>
                        <entry key="Solved Remotely (Work Around)" value="Committed"/>
                      </Map>
                    </value>
                  </entry>
                </Map>
              </value>
            </entry>
            <entry key="provision">
              <value>
                <Map>
                  <entry key="request">
                    <value>
                      <Map>
                        <entry key="u_assignment_group" value="Service Desk"/>
                        <entry key="u_caller_id" value="$!plan.arguments.requested_for"/>
                        <entry key="u_contact_type" value="email"/>
                        <entry key="u_description" value="#foreach($req in $plan.requests) #if($req.operation == &apos;Create&apos;) Create Account on application $req.resource #else For $req.id in application $req.resource #end #if($req.items) $newline  #foreach($item in $req.items) #if ($item.name == &apos;*disabled*&apos; &amp;&amp; $item.value == &apos;true&apos;) Disable Account. $newline #elseif ($item.name == &apos;*disabled*&apos; &amp;&amp; $item.value == &apos;false&apos;) Enable Account. $newline #elseif ($item.name == &apos;*locked*&apos; &amp;&amp; $item.value == &apos;false&apos;) Unlock Account. $newline #else $!item.Operation $item.name: $item.value $newline #end #end #else $newline $!req.Operation Account #end #end"/>
                        <entry key="u_impact" value="3"/>
                        <entry key="u_opened_by" value="$!plan.arguments.opened_by"/>
                        <entry key="u_short_description" value="IdentityIQ Access Request $!plan.arguments.identityRequestId"/>
                        <entry key="u_urgency" value="3"/>
                      </Map>
                    </value>
                  </entry>
                  <entry key="resource" value="/api/now/import/x_sap_sdim_incident"/>
                  <entry key="responseElement" value="result[0].display_value"/>
                </Map>
              </value>
            </entry>
          </Map>
        </value>
      </entry>
      <entry key="nativeChangeDetectionAttributeScope" value="entitlements"/>
      <entry key="nativeChangeDetectionAttributes"/>
      <entry key="nativeChangeDetectionEnabled">
        <value>
          <Boolean></Boolean>
        </value>
      </entry>
      <entry key="nativeChangeDetectionOperations"/>
      <entry key="password" value="%%ELE_SNOW_PASSWORD%%"/>
      <entry key="serviceRequest">
        <value>
          <Map>
            <entry key="checkStatus">
              <value>
                <Map>
                  <entry key="checkStatusQueryParam">
                    <value>
                      <Map>
                        <entry key="sysparm_fields" value="request_state"/>
                        <entry key="sysparm_query" value="number=$ticketId"/>
                      </Map>
                    </value>
                  </entry>
                  <entry key="resource" value="/api/now/table/sc_request"/>
                  <entry key="responseElement" value="$.result[0].request_state"/>
                  <entry key="statusMap">
                    <value>
                      <Map>
                        <entry key="closed_cancelled" value="Failed"/>
                        <entry key="closed_complete" value="Committed"/>
                        <entry key="closed_incomplete" value="Failed"/>
                        <entry key="closed_rejected" value="Failed"/>
                        <entry key="closed_skipped" value="Failed"/>
                        <entry key="in_process" value="Queued"/>
                        <entry key="requested" value="Queued"/>
                      </Map>
                    </value>
                  </entry>
                </Map>
              </value>
            </entry>
            <entry key="provision">
              <value>
                <Map>
                  <entry key="catalogItem">
                    <value>
                      <Map>
							<entry key="Blackline" value="%%ELE_SNOW_BLACKLINE_MAP%%"/>
							<entry key="Collateral" value="%%ELE_SNOW_COLLATERAL_MAP%%"/>
							<entry key="Contpaq BANCOS" value="%%ELE_SNOW_CONTPAQ_BANCOS_MAP%%"/>
							<entry key="Contpaq Commercial" value="%%ELE_SNOW_CONTPAQ_COMMERCIAL_MAP%%"/>
							<entry key="DriverCare" value="%%ELE_SNOW_DRIVERCARE_MAP%%"/>
							<entry key="DriverCare MS SQL Database" value="%%ELE_SNOW_MSSQL_DRIVERCARE_MAP%%"/>
							<entry key="FDC Billing" value="%%ELE_SNOW_FDC_BILLING_MAP%%"/>
							<entry key="FDC Billing MS SQL Database" value="%%ELE_SNOW_MSSQL_FDC_BILLING_MAP%%"/>
							<entry key="FSP" value="%%ELE_SNOW_FSP_MAP%%"/>
							<entry key="GEAC" value="%%ELE_SNOW_GEAC_MAP%%"/>
							<entry key="Great Plains" value="%%ELE_SNOW_GREAT_PLAINS_MAP%%"/>
							<entry key="Intelliclaim" value="%%ELE_SNOW_INTELLICLAIM_MAP%%"/>
							<entry key="MS Dynamics" value="%%ELE_SNOW_MS_DYNAMICS_MAP%%"/>
							<entry key="MS Dynamics MS Sql Database" value="%%ELE_SNOW_MSSQL_MS_DYNAMICS_MAP%%"/>
							<entry key="NVP" value="%%ELE_SNOW_NVP_MAP%%"/>
							<entry key="Oasis" value="%%ELE_SNOW_OASIS_MAP%%"/>
							<entry key="OnBase" value="%%ELE_SNOW_ONBASE_MAP%%"/>
							<entry key="OnBase MS Sql Database" value="%%ELE_SNOW_MSSQL_ONBASE_MAP%%"/>
							<entry key="OneStream" value="%%ELE_SNOW_ONESTREAM_MAP%%"/>
							<entry key="eInvoicing" value="%%ELE_SNOW_EINVOICE_MAP%%"/>
                      </Map>
                    </value>
                  </entry>
                  <entry key="request">
                    <value>
                      <Map>
                        <entry key="application" value="$!plan.arguments.application"/>
                        <entry key="common_comment" value="#if($request.operation == &apos;Create&apos;) Create Account on application $request.resource #else For $request.id in application $request.resource #end #if ($request.items) $newline  #foreach ($item in $request.items) #if ($item.name == &apos;*disabled*&apos; &amp;&amp; $item.value == &apos;true&apos;) Disable Account. $newline #elseif ($item.name == &apos;*disabled*&apos; &amp;&amp; $item.value == &apos;false&apos;) Enable Account. $newline #elseif ($item.name == &apos;*locked*&apos; &amp;&amp; $item.value == &apos;false&apos;) Unlock Account. $newline #else $!item.Operation $item.name: $item.value $newline #end #end #else $newline $!request.Operation Account #end"/>
                        <entry key="description" value="#if($request.operation == &apos;Create&apos;) Create Account on application $request.resource #else For $request.id in application $request.resource #end #if ($request.items) $newline  #foreach ($item in $request.items) #if ($item.name == &apos;*disabled*&apos; &amp;&amp; $item.value == &apos;true&apos;) Disable Account. $newline #elseif ($item.name == &apos;*disabled*&apos; &amp;&amp; $item.value == &apos;false&apos;) Enable Account. $newline #elseif ($item.name == &apos;*locked*&apos; &amp;&amp; $item.value == &apos;false&apos;) Unlock Account. $newline #else $!item.Operation $item.name: $item.value $newline #end #end #else $newline $!request.Operation Account #end"/>
                        <entry key="opened_by" value="$!plan.arguments.opened_by"/>
                        <entry key="req_description" value="Service Request created by Service Integration Module (SIM) - IdentityIQ for ServiceNow Service Desk"/>
                        <entry key="request_type" value="Revoke"/>
                        <entry key="requested_for" value="$!plan.arguments.requested_for"/>
                        <entry key="short_description" value="IdentityIQ Access Request $!plan.arguments.identityRequestId"/>
                      </Map>
                    </value>
                  </entry>
                  <entry key="requestObject" value="items"/>
                  <entry key="resource" value="/api/x_sap_sdim/sailpoint_cart_js_api/create_ticket"/>
                  <entry key="responseElement" value="$.result.request_number"/>
                </Map>
              </value>
            </entry>
          </Map>
        </value>
      </entry>
      <entry key="sysDescriptions">
        <value>
          <Map>
            <entry key="en_US"/>
          </Map>
        </value>
      </entry>
      <entry key="templateApplication" value="ServiceNow Service Desk"/>
      <entry key="ticketType" value="serviceRequest"/>
      <entry key="token_url" value="https://demo.service-now.com/oauth_token.do"/>
      <entry key="url" value="https://elementcorpdev.service-now.com"/>
      <entry key="username" value="%%ELE_SNOW_USERNAME%%"/>
    </Map>
  </Attributes>
  <Owner>
    <Reference class="sailpoint.object.Identity" name="spadmin"/>
  </Owner>
  <ProvisioningConfig>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="Blackline"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="Contpaq COMMERCIAL"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="Contpaq BANCOS"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="OneStream"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="DriverCare"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="GEAC"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="OnBase"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="eInvoicing"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="MS Dynamics"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="NVP"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="Great Plains"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="Oasis"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="FSP"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="Collateral"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="Intelliclaim"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="FDC Billing"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="OnBase MS Sql Database"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="MS Dynamics MS Sql Database"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="DriverCare MS SQL Database"/>
      </ApplicationRef>
    </ManagedResource>
    <ManagedResource>
      <ApplicationRef>
        <Reference class="sailpoint.object.Application" name="FDC Billing MS SQL Database"/>
      </ApplicationRef>
    </ManagedResource>
    <PlanInitializerScript>
      <Source>
<![CDATA[
        import sailpoint.object.Identity;
        import sailpoint.object.Link;
        import sailpoint.object.IntegrationConfig;
        import sailpoint.object.Application;
        import sailpoint.api.IdentityService;

        /**
         * Fields
         */
        String applicationType = "ServiceNow";
        // Identity attribute on SailPoint/ UserID on ServiceNow
        String userId = "sys_id";

        /**
         * Get ServiceNow Account name for identity using application type - ServiceNow
         */
        private String getLinkByAppType(Identity identity) {
            if (identity == null) {
                return null;
            }

            List links = identity.getLinks();
            String linkName = null;
            if (links != null ) {
                for (Link link : links) {
                    String appType = link.getApplication().getType();
                    if (appType != null && appType.equals(applicationType)) {
                        if(link.getAttribute(userId) != null) {
                            String userName = link.getAttribute(userId);
                            if(userName != null) {
                                linkName = userName;
                                break;
                            }
                        }
                    }
                }
            }

            return linkName;
        }
				
         /**
         * Get ServiceNow Account name for Identity using application name
         */
        private String getFormatedAppName(String appName){
        		String returnAppName = "";
        		if (appName.equalsIgnoreCase("OnBase MS Sql Database")){
					reurnAppName = "Onbase (PROD)"
        		}
        		else if(appName.equalsIgnoreCase("MS Dynamics MS Sql Database")){
        				reurnAppName = "DYNAMICS (PROD)"
        		}	
						else if(appName.equalsIgnoreCase("FDC Billing MS SQL Database")){
        				returnValue = "Billing (cei)";	
        		}	
        		else if(appName.equalsIgnoreCase("DriverCare MS SQL Database")){
        				returnValue = appName;	
        		}	        `
`
        		return returnAppName;
        }
        /**
         * Get ServiceNow Account name for Identity using application name
         */
        private String getLinkByAppName(Identity identity, String connectorAppForServiceNow) {
            if (identity == null) {
                return null;
            }

            String linkName = null;
            if (connectorAppForServiceNow != null) {
                Application app = context.getObjectByName(Application.class, connectorAppForServiceNow);
                IdentityService identService = new IdentityService(context);
                List links = identService.getLinks(identity, app);
                Link link = null;
                if (links != null && links.size() > 0) {
                    link = links.get(0);
                }

                if (link != null) {
                    String userName = (String) link.getAttribute(userId);
                    if (userName != null) {
                        linkName = userName;
                    }
                }
            }

            return linkName;
        }

        ////////////////////////////////////////////////////////////////
        // Main
        ////////////////////////////////////////////////////////////////
        Map arguments = (Map)plan.getArguments();
        List requesterList = plan.getRequesters();
        Identity requester = null;
        if (requesterList != null) {
            requester = requesterList.get(0);
            if (requester != null && requester.getName() != null) {
                requester = context.getObjectByName(Identity.class, requester.getName());
            }
        }

        String appName = integration.getName();
        if (appName != null) {
            Application appObject = context.getObjectByName(Application.class, appName);
            connectorAppForServiceNow = appObject.getAttributeValue("connectorAppForServiceNow");
        }
				
        // Get ServiceNow Account name
        if (connectorAppForServiceNow != null) {
            openedBy = getLinkByAppName(requester, connectorAppForServiceNow);
            requestedFor = getLinkByAppName(identity, connectorAppForServiceNow);
        } else {
            openedBy = getLinkByAppType(requester);
            requestedFor = getLinkByAppType(identity);
        }
		if (appName != null){
			String fmtAppName = getFormatedAppName(appName);
			arguments.put("application", fmtAppName);
        }
        if (requestedFor != null) {
            arguments.put("requested_for", requestedFor);
        }

        if (openedBy != null) {
            arguments.put("opened_by", openedBy);
        }
		]]>
      </Source>
    </PlanInitializerScript>
  </ProvisioningConfig>
  <ApplicationScorecard/>
</Application>
