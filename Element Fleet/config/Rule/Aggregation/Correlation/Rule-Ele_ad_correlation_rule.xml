<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE Rule PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Rule language="beanshell" name="ELE_AD_Correlation_Rule" type="Correlation">
    <Description>Identity Correlation Rules are used to find identities to which new accounts can be attached.
A correlation rule must return a Map with one of the specified Return arguments.</Description>
    <Signature returnType="Map">
        <Inputs>
            <Argument name="log">
                <Description>
          The log object associated with the SailPointContext.
        </Description>
            </Argument>
            <Argument name="context">
                <Description>
          A sailpoint.api.SailPointContext object that can be used to query the database if necessary.
        </Description>
            </Argument>
            <Argument name="environment" type="Map">
                <Description>
          Arguments passed to the aggregation task.
        </Description>
            </Argument>
            <Argument name="application">
                <Description>
          Application being aggregated.
        </Description>
            </Argument>
            <Argument name="account">
                <Description>
          A sailpoint.object.ResourceObject returned from the
          collector.
        </Description>
            </Argument>
            <Argument name="link">
                <Description>
          Existing link to this account.
        </Description>
            </Argument>
        </Inputs>
        <Returns>
            <Argument name="identityName">
                <Description>
          The name of an Identity object.
        </Description>
            </Argument>
            <Argument name="identity">
                <Description>
          A fully resolved Identity object if the rule wants
          to do its own queries to locate the identity.
        </Description>
            </Argument>
            <Argument name="identityAttributeName">
                <Description>
          The name of the extended attribute that can be used
          to locate an existing identity.
        </Description>
            </Argument>
            <Argument name="identityAttributeValue">
                <Description>
          The value of the named extended attribute that can be used
          to locate an existing identity. This attribute is used
          together with the identityAttributeName argument.
        </Description>
            </Argument>
        </Returns>
    </Signature>
    <Source><![CDATA[
			import sailpoint.object.*;
			Map returnMap = new HashMap();
			String sAMAccountName = account.getStringAttribute("sAMAccountName");
			String identityName= account.getStringAttribute("msDS-PrincipalName");
			String userDN = account.getStringAttribute("distinguishedName");
			String employeeType = account.getStringAttribute("employeeType");
			userDN= userDN.toLowerCase();
			if(userDN.contains(",ou=element,ou=people,dc=ceinetwork,dc=net")) employeeType ="Element ACCOUNT";
			if(userDN.contains(",ou=service accounts,")) employeeType ="SERVICE_ACCOUNT";
			if(userDN.contains(",ou=serviceaccounts,")) employeeType ="SERVICE_ACCOUNT";
			if(sAMAccountName.toLowerCase().endsWith("-admin") || sAMAccountName.toLowerCase().endsWith("-net") || sAMAccountName.toLowerCase().endsWith("-dba")){
				sAMAccountName= sAMAccountName.substring(0, sAMAccountName.indexOf("-"));
			}
			if(sAMAccountName.toLowerCase().endsWith("_admin") || sAMAccountName.toLowerCase().endsWith("_net") || sAMAccountName.toLowerCase().endsWith("_dba")){
				sAMAccountName= sAMAccountName.substring(0, sAMAccountName.indexOf("_"));
			}
			QueryOptions qo= new QueryOptions();
			qo.addFilter(Filter.or(Filter.eq("application.name", "CEI AD"),Filter.ignoreCase(Filter.eq("application.name", "Element AD"))));
			qo.addFilter(Filter.ignoreCase(Filter.eq("loginid", sAMAccountName)));
			Iterator iter = context.search(Link.class, qo,"id");
			boolean found = false;
			while (iter.hasNext()) {
				found=true;
				Object[] row = (Object[]) iter.next();
				String id = (String) row[0];
				Link adLink = context.getObjectById(Link.class,id);
				String idName= adLink.getIdentity().getName();
				returnMap.put("identityName",idName);	
			}
			if(!found)	returnMap.put("identityName",identityName);	
			return returnMap;
	]]></Source>
</Rule>